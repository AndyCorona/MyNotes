# 第一章 Redis6 起步

Redis 是一个 NoSQL 数据库(Not Only SQL)，即非关系型数据库。非关系型数据库不遵循 SQL 标准，不支持 ACID，往往以简单的 key-value 模式存储数据，有着远超于关系型数据库的性能。

### 1.1 key 通用命令

Redis 基于 key-value 的映射关系存储数据。当创建一个 key-value 时，Redis 会创建两个对象。一个对象用于 key，称为键对象，key 总是为 String 类型；另一个对象用于 value，称为值对象，value 可以是 String, List 和 Set 等类型。下表列出一些通用命令：

| 命令            | 说明                                                       |
| --------------- | ---------------------------------------------------------- |
| keys \*         | 查看当前库中所有 key                                       |
| exists \<key>     | 判断某个 key 是否存在                                      |
| type \<key>     | 返回指定 key 的类型                                        |
| del \<key>      | 立刻删除指定 key                                           |
| unlink \<key>   | 异步删除指定 key                                           |
| expire \<key> \<seconds> | 设置 key 过期时间（秒为单位）                              |
| ttl \<key>      | 查看 key 有效时间，-1 表示永不过期，-2 表示已过期          |
| select \<n>     | 切换到 n 号数据库，默认有 16 个数据库，默认在 0 号数据库中 |
| dbsize          | 查看当前库 key 的数量                                      |
| flushdb         | 清空当前库                                                 |
| flushall        | 清空所有库                                                 |

### 1.2 数据类型

Redis 里的数据类型针对于  value，key 永远为 String 类型。

#### 1.2.1 String

String 是 Redis 最基本的数据类型。当 value 为 String 类型时，有以下特定命令：

**常用命令**

| 命令                                          | 说明                                          |
| --------------------------------------------- | --------------------------------------------- |
| set \<key> \<value>                           | 设置 value，会覆盖原 value                    |
| get \<key>                                    | 查看 value                                    |
| append \<key> \<value>                        | 追加 value                                    |
| strlen \<key>                                 | 查看 value 长度                               |
| setnx  \<key> \<value>                        | 设置 value，不会覆盖原 value                  |
| incr/decr \<key>                              | 将数字形式的 value +1/-1                      |
| incrby/decrby \<key> \<n>                     | 将数字形式的 value +n/-n                      |
| mset \<key1> \<value1> \<key2> \<value2>...   | 同时设置多个 value，会覆盖原 value            |
| mget \<key1> \<key2> ...                      | 同时查看多个 value                            |
| msetnx \<key1> \<value1> \<key2> \<value2>... | 同时设置多个 value，不会覆盖原 value          |
| getrange \<key> \<start> \<end>               | 查看 value 索引 start ~ end 的值              |
| setrange \<key> \<start> \<value>             | 从原 value 的 start 索引开始，用新 value 覆盖 |
| setex \<key> \<seconds> \<value>              | 设置 value 时指定过期时间                     |
| getset \<key> \<value>                        | 设置新 value 同时查看旧 value                 |

```redis
127.0.0.1:6379> set k1 v1
OK

127.0.0.1:6379> get k1
"v1" #返回 value

127.0.0.1:6379> append k1 append
(integer) 8 #追加后返回 value 长度

127.0.0.1:6379> strlen k1
(integer) 8 #返回 value 长度

127.0.0.1:6379> setnx k1 v1
(integer) 0 #返回 false，无法覆盖原 value

127.0.0.1:6379> setnx k2 v2
(integer) 1 #返回 true，可以设置不存在的 value

127.0.0.1:6379> incr k1
(error) ERR value is not an integer or out of range #报错，非数字形式的 value 无法自增

127.0.0.1:6379> incr k3
(integer) 101 #返回自增后的值

127.0.0.1:6379> incrby k1 10
(error) ERR value is not an integer or out of range #报错，非数字形式的 value 无法自增

127.0.0.1:6379> incrby k3 10
(integer) 111 #返回增加指定步长后的 value

127.0.0.1:6379> mset k4 v4 k5 v5
OK

127.0.0.1:6379> mget k4 k5
1) "v4"
2) "v5" #返回同时获取到的 value

127.0.0.1:6379> msetnx k4 v4 k5 v5 k6 v6
(integer) 0 #返回 false，只要有一个 value 已存在，就设置失败（原子性操作）

127.0.0.1:6379> msetnx k6 v6 k7 v7
(integer) 1 #返回 true

127.0.0.1:6379> get k1
"v1append"
127.0.0.1:6379> getrange k1 2 4
"app" #返回 value 索引 2~4 的子串

127.0.0.1:6379> setrange k1 2 bbb
(integer) 8 #覆盖完后返回 value 长度
127.0.0.1:6379> get k1
"v1bbbend"

127.0.0.1:6379> setex k5 5 v5
OK
127.0.0.1:6379> ttl k5
(integer) 3
127.0.0.1:6379> ttl k5
(integer) 1
127.0.0.1:6379> ttl k5
(integer) -2 #已过期

127.0.0.1:6379> getset k1 v1
"v1bbbend" #设置新 value，同时返回旧 value
```

#### 1.2.2 List

当 value 为 List 类型时，有以下特定命令：

| 命令                                              | 说明                                                         |
| ------------------------------------------------- | ------------------------------------------------------------ |
| lpush/rpush \<key> \<member1> \<member2>...       | 从左边/右边压入若干个 member                                 |
| lpop/rpop \<key>                                  | 从左边/右边弹出一个 member，value 中的所有 member 都被弹出后，key 被销毁 |
| rpoplpush \<key1> \<key2>                         | 从 key1 的右边弹出一个 member，压入到 key2 的左边            |
| lrange \<key> \<start> \<stop>                    | 按照索引从左到右查看 member，0 表示左边第一个，-1 表示右边第一个 |
| lindex \<key> \<index>                            | 按照指定索引查看 member                                      |
| llen \<key>                                       | 查询 value 长度                                              |
| linsert \<key> before\after \<member> \<newvalue> | 在 member 前面\后面插入 newmember                            |
| lrem \<key> \<n> \<member>                        | 从左边开始删除 n 个 member                                   |
| lset \<key> \<index> \<member>                    | 索引为 index 的原 member 替换成新 member                     |

```redis
127.0.0.1:6379> lpush k1 v1 v2 v3
(integer) 3 #返回 member 个数

127.0.0.1:6379> rpush k2 value1 value2 value3
(integer) 3

127.0.0.1:6379> lrange k1 0 -1  #从左到右查看所有 member
1) "v3"
2) "v2"
3) "v1"
127.0.0.1:6379> lrange k2 0 -1
1) "value1"
2) "value2"
3) "value3"

127.0.0.1:6379> lpop k1
"v3" #返回弹出的 member

127.0.0.1:6379> rpoplpush k1 k2
"v1" #返回 member
127.0.0.1:6379> lrange k2 0 -1
1) "v1"
2) "value1"
3) "value2"
4) "value3"

127.0.0.1:6379> lindex k2 0
"v1" #返回指定索引的 member

127.0.0.1:6379> llen k2
(integer) 4  #返回 value 长度

127.0.0.1:6379> linsert k2 before v1 v0
(integer) 5 #返回 value 长度

127.0.0.1:6379> lrem k2 5 v0
(integer) 1 #返回删除的个数

127.0.0.1:6379> lset k2 0 value0
OK
```

#### 1.2.3 Set

Set 和 List 类似，但不会储存重复的数据。当 value 为 Set 类型时，有以下特定命令：

| 命令                                     | 说明                                            |
| ---------------------------------------- | ----------------------------------------------- |
| sadd \<key> \<member1> \<member2>...     | 添加若干个 member，已存在的 member 将被忽略添加 |
| smembers \<key>                          | 查看所有 member                                 |
| sismember \<key> \<member>               | 判断是否有 member                               |
| scard \<key>                             | 查看 member 个数                                |
| srem \<key> \<member1> \<member2>        | 删除指定 member                                 |
| spop \<key>                              | 随机弹出一个 member                             |
| srandmember \<key> \<n>                  | 随机查看 n 个 member                            |
| smove \<source> \<destination> \<member> | 一个集合中的 member 移动到另一个集合中          |
| sinter \<key1> \<key2>                   | 查询交集 member                                 |
| sunion \<key1> \<key2>                   | 查询并集 member                                 |
| sdiff \<key1> \<key2>                    | 查询差集 member，即 key1 有但 key2 没有的member |

```redis
127.0.0.1:6379> sadd k1 m1 m2 m3
(integer) 3 #返回 member 个数

127.0.0.1:6379> smembers k1
1) "m1"
2) "m3"
3) "m2"

127.0.0.1:6379> sismember k1 m3
(integer) 1 #返回 true

127.0.0.1:6379> scard k1
(integer) 3 #返回 member 个数

127.0.0.1:6379> srem k1 m2 m3
(integer) 2 #返回删除个数

127.0.0.1:6379> spop k1
"m1" #返回弹出的 member

127.0.0.1:6379> srandmember k1 2
1) "m3"
2) "m2"

127.0.0.1:6379> smove k1 k2 m1
(integer) 1 #返回 true，移动成功

127.0.0.1:6379> sinter k1 k2
1) "m1" #返回交集 member

127.0.0.1:6379> sunion k1 k2
1) "m3"
2) "m2"
3) "member1"
4) "m1"
5) "member2"
6) "member3" #返回并集 member

127.0.0.1:6379> sdiff  k1 k2
1) "m3"
2) "m2" #返回差集 member
```
#### 1.2.4 Hash

当 value 为 Hash 类型时（Hash 中的键值对用 field-member 表示），有以下特定命令：

| 命令                                                       | 说明                                           |
| ---------------------------------------------------------- | ---------------------------------------------- |
| hset \<key> \<field> \<member>                             | 给 field 赋值 member，会覆盖原 member          |
| hget \<key1>  \<field>                                     | 查询 field 对应的 member                       |
| hmset \<key1> \<field1> \<member1> \<field2> \<member2>... | 同时设置多个 field-member                      |
| hexists \<key1> \<field>                                   | 判断是否存在 field                             |
| hkeys \<key>                                               | 列出所有 field                                 |
| hvals \<key>                                               | 列出所有 member                                |
| hincrby \<key> \<field> \<increment>                       | field 对应的 数字形式的 member 增加  increment |
| hsetnx \<key> \<field> \<member>                           | 给 field 赋值 member，不会覆盖原 member        |

```redis
127.0.0.1:6379> hset key1 field1 member1
(integer) 1

127.0.0.1:6379> hget key1 field1
"member1"

127.0.0.1:6379> hmset keyA fieldA memberA fieldB memberB
OK

127.0.0.1:6379> hexists key1 field1
(integer) 1 #返回 true

127.0.0.1:6379> hkeys keyA
1) "fieldA"
2) "fieldB"

127.0.0.1:6379> hvals keyA
1) "memberA"
2) "memberB"
```

#### 1.2.5 Zset

Zset 和 Set 类似，但是 member 有序排列，每个 member 和一个权重 score 绑定。有以下特定命令：

| 命令                                                    | 说明                                      |
| ------------------------------------------------------- | ----------------------------------------- |
| zadd \<key> \<score1> \<member1>\<score2> \<member2>... | 添加若干个 member 及其 score              |
| zrange \<key> \<start> \<stop> [withscores]             | 查询索引 start~stop 的 member             |
| zrangebyscore key min max [withscores]                  | 查询 score 位于 [min max] 的 member，升序 |
| zrevrangebyscore key max min [withscores]               | 查询 score 位于 [max min] 的 member，降序 |
| zincrby \<key> \<increment> \<member>                   | 为 member 的 score 增加指定增量           |
| zrem \<key> \<member>                                   | 删除指定 member                           |
| zcount \<key> \<min> \<max>                             | 查询 [min max]  区间内的 member 个数      |
| zrank \<key> \<member>                                  | 查询该 member 的排名，从 0 开始           |

```redis
127.0.0.1:6379> zadd key1 100 A 200 B 300 C
(integer) 3 #返回添加的 member 个数

127.0.0.1:6379> zrange key1 0 -1 withscores
1) "A"
2) "100"
3) "B"
4) "200"
5) "C"
6) "300"

127.0.0.1:6379> zrevrangebyscore key1 300 100 withscores
1) "C"
2) "300"
3) "B"
4) "200"
5) "A"
6) "100"

127.0.0.1:6379> zrangebyscore key1 100 300 withscores
1) "A"
2) "100"
3) "B"
4) "200"
5) "C"
6) "300"

127.0.0.1:6379> zincrby key1 100 C
"400" #返回增加后的 score

127.0.0.1:6379> zrem key1 A B
(integer) 2 #返回删除的 member 个数

127.0.0.1:6379> zcount key1 100 300
(integer) 3

127.0.0.1:6379> zrank key1 B
(integer) 1 #排名第 2
```

#### 1.2.6 Bitmaps

Bitmaps 为 bit 数组（数组中只存储 0 和 1），处理非常大量数据时优于之前的五种数据类型。当 value 为 Bitmaps 类型时，有以下特定命令：

| 命令                                                 | 说明                                                       |
| ---------------------------------------------------- | ---------------------------------------------------------- |
| setbit \<key> \<offset> <0 \| 1>                     | 设置偏移量的值为 0 或 1，不设置默认为 0                    |
| getbit \<key> \<offset>                              | 查询偏移量的值                                             |
| bitcount \<key> \<start> \<end>                      | 查询从 start~end **字节数组**中偏移量值为 1 的比特数目     |
| bitop <and/or/not/xor> \<destkey> \<key1> \<key2>... | 对不同的 bit 数组进行逻辑操作，结果放在 destkey bit 数组中 |

```redis
127.0.0.1:6379> setbit key1 10 1
(integer) 0

127.0.0.1:6379> getbit key1 10 
(integer) 1

127.0.0.1:6379> bitcount key1 0 -1
(integer) 2
```

#### 1.2.7 HyperLoglog

HyperLoglog 类似 Set，存储不重复的数据，比 Set 更适合处理非常大量的数据，当 value 为 HyperLoglog 类型时，有以下特定命令：

| 命令                                  | 说明                                          |
| ------------------------------------- | --------------------------------------------- |
| pfadd \<key> \<member1> \<member2>... | 添加若干个 member                             |
| pfcount \<key1>...                    | 查询不重复的 member 个数                      |
| pfmerge \<destkey> \<sourcekey1>...   | 合并若干个 HyperLoglog，结果保存到 destkey 中 |

#### 1.2.8 Geospatial

Geospatial 是对地理经纬度的描述。当 value 为 Geospatial 类型时，有以下特定命令：

| 命令                                                         | 说明                                        |
| ------------------------------------------------------------ | ------------------------------------------- |
| geoadd \<key> \<longitude> \<latitude> \<member>...          | 添加若干个 member 的经纬度                  |
| geopos \<key> \<member1>...                                  | 查询 member 的经纬度                        |
| geodist \<key> \<member1> \<member2> [m\| km \| ft \| mi]    | 获取两个 member 之间的直线距离              |
| georadius \<key> \<longtitude> \<latitude> \<radius> [m\|km \|ft \|mi] | 以经纬度为中心，找出 radius 半径内的 member |


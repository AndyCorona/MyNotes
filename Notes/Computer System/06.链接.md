# 第六章 链接

链接是将各种代码和数据片段收集并组合成一个单一文件的过程。可以在编译时、加载时和运行时执行链接。在现代系统中，链接器会自动执行链接。

### 编译器驱动程序

大多数编译系统提供编译器驱动程序，在用户需要时调用预处理器、编译器、汇编器和链接器。

使用 GCC 将 C 源代码文件 main.c 和 sum.c 翻译成可执行目标文件 prog 时经历 4 个步骤：
预处理器 (cpp) 分别将 C 源文件 main.c 和 sum.c 翻译成中间文件 main.i 和 sum.i。
编译器 (ccl) 分别将 main.i 和 sum.i 翻译成汇编文件 main.s 和 sum.s。
汇编器 (as) 分别将 main.s 和 sum.s 翻译成可重定位目标文件 main.o 和 sum.o。
链接器 (ld) 将 main.o, sum.o 和其他一些必要的系统目标文件组合起来，创建一个可执行目标文件 prog。

![image-20220117164812358](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220117164812358.png)

### 目标文件

目标文件有三种形式：

-   可重定位目标文件：包含二进制代码和数据，在编译时可与其他可重定位目标文件合并，创建一个可执行目标文件。
-   可执行目标文件：包含二进制代码和数据，可以被加载器复制到内存中执行。
-   共享目标文件：一种特殊类型的可重定位目标文件。在程序加载或运行时被动态加载到内存中并链接。

不同操作系统的目标文件格式不同。Windows 使用 PE 格式，Mac-OS 使用 Mach-O 格式，现代 Linux 和 Unix 使用 ELF 格式。

### 可重定位目标文件

下图展示一个典型的 ELF 可重定位目标文件的结构。

ELF header：包含系统的字大小、字节顺序、ELF 头大小、目标文件类型、机器类型等信息。
.text 节：保存已编译程序的机器码。
.rodata 节：包含只读数据，例如 printf 语句中的格式字符串和 switch 语句中的跳转表。
.data 节：已初始化的全局和静态 C 变量。局部变量被保存在运行时栈中，不出现在 .data 和 .bss 节中。
.bss 节：未初始化的全局和静态 C 变量，以及所有被初始化为 0 的全局和静态 C 变量。运行时内存才为这些变量分配初始值 0。
.symtab 节：一张存放程序中定义和使用过的函数与全局变量的符号表。
.rel.text 节：一个 .text 节中的位置列表。当链接器把目标文件和其他文件组合时需要修改这些位置。
.rel.data 节：被使用或定义的所有全局变量的重定位信息。
.debug 节：一张调试符号表。存放程序中定义的局部变量和类型、程序中定义的全局变量和原始的 C 源文件。必须用 -g 选项才能获取这张表。
.line 节：原始 C 源程序中的行号和 .text 节中机器码之间的映射表。必须用 -g 选项才能获取这张表。
.strtab 节：一个包含 .symtab 节和 .debug 节中符号表的字符串表。
Section header  table：描述目标文件不同节的位置和大小。

![典型的 ELF 可重定位目标文件](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220118095511720.png)

### 符号和符号表

每个可重定位目标文件都有一张符号表，包含定义和使用过的符号。符号可分为三种：

-   全局符号：由目标文件定义并能被其他目标文件使用。全局符号对应目标文件中定义的非静态的 C 函数和全局变量。
-   外部符号：由其他目标文件定义并被当前目标文件使用的全局符号。外部符号对应于其他目标文件中定义的非静态的 C 函数和全局变量。
-   局部符号：只在目标文件内定义和使用。局部符号对应静态的函数和全局变量。

汇编器生成符号表。符号表是一个由许多条目组成的数组。每个条目的格式如下：

![符号表条目格式](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220118153359481.png)

GUN READEFL 程序可以查看目标文件的内容。下图展示一个目标文件符号表的最后三个条目。

![符号表](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220118154654063.png)

全局符号 main 是位于 .text 节 (Ndx=1) 中偏移量为 0 (Value=0) 的 24 (Size=24) 字节函数 (Type=FUNC) 。
全局符号 array 是位于 .data 节 (Ndx=3) 中偏移量为 0 处的 8 字节目标 (Type=OBJECT) 。
全局符号 sum 是在其他地方定义，在该目标文件中使用 (Ndx=UND)。

### 符号解析

编译器在编译时向汇编器输出每个符号，汇编器把符号编码在可重定位目标文件的符号表里。链接器负责符号解析。函数和已初始化的全局变量是强符号；未初始化的全局变量是弱符号。

Linux 使用下列规则处理多重定义的符号：

-   一个符号表中不允许定义多个同名的强符号；
-   如果一个强符号和多个弱符号同名，选择强符号；
-   如果有多个同名弱符号，从中任意选一个。

fun1.c 和 fun2.c 中都定义了强符号 main。链接器报错：强符号 main 被定义多次。

```c
/* fun1.c */
int main(){
    return 0;
}

/* fun2.c */
int main(){ //main 被定义多次
    return 0;
}
```

fun1.c 定义了强符号 x，fun2.c 定义了弱符号 x。当执行 f() 函数时，f() 函数里的 x 会选择强符号 x 而不是弱符号 x，最终的结果是 fun1.c 里的 强符号 x 被修改为 100。

```c
/* fun1.c */
void f();

int x = 10; //强符号 x
int main(){
    f();
    return 0;
}

/* fun2.c */
int x; //弱符号 x

void f(){
    x = 100; 
}
```
fun1.c 和 fun2.c 都定义了弱符号 x。当执行 f() 函数时，符号 x 的值被修改为 100。
```c
/* fun1.c */
void f();

int x; //弱符号 x
int main(){
    x = 10;
    f();
    return 0;
}

/* fun2.c */
int x; //弱符号 x

void f(){
    x = 100;
}
```

将所有目标文件打包成一个单独的文件称为静态库。当链接器输出一个可执行文件时，可能只复制静态库里被当前程序使用的目标文件。如下图所示，链接时只使用了静态库 libc.a 中的 printf.o 和调用 printf.o 的其他目标文件。 

![静态库](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220120154243996.png)

### 重定位

链接器完成符号解析后，进行重定位。

链接器将所有相同类型的节合并为同一类型的聚合节。例如所有可重定位目标文件的 .data 节被合并成一个节，这个节作为可执行目标文件的 .data 节。链接器修改符号的地址，使得它们指向正确的运行时地址。

ELF 定义了 32 种不同的重定位类型。下面是两种最基本的重定位类型：
R_X86_64_PC32：使用相对于 PC 的 32 位地址
R_X856_64_32：使用 32 位绝对地址

### 可执行目标文件

下图展示一个典型的 ELF 可执行目标文件的结构。

![典型的 ELF 可执行目标文件](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220120165813579.png)

段头部表记录了可执行目标文件和内存的映射关系。如下头部表所示，目标文件的第一个段偏移为 0，大小为 0x69c 字节，占用内存大小 0x69c 字节，有读/执行权限，开始于内存地址 0x400000 处。该段包括 ELF 头、段头部表、.init 节、.text 节和 .rodata 节。

目标文件的第二个段偏移为 0xdf8，大小为 0x228 字节，占用内存大小 0x0x230 字节，有读/写权限，开始于内存地址 0x600df8 处。该段包括 .data 节和 .bss 节。

![段头部表](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220120170721936.png)

off：在目标文件中的偏移；vaddr/paddr：内存地址；filesz：目标文件中的段大小；memsz：内存中的段大小；flags：运行时权限

运行可执行目标文件时，调用加载器将可执行目标文件的代码和数据从磁盘复制到内存中，然后通过跳转到程序的第一条指令或入口点来执行该程序。

加载器运行时创建如下图所示的内存映射。在头部表的的引导下将可执行目标文件的内容复制到代码段和数据段。![运行时内存映射](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220121095244980.png)

### 动态链接共享库

共享库是在运行或加载时可被复制到任意内存地址的目标文件。动态链接器将共享库和内存中的一个程序链接。

![动态链接](E:\BaiduNetdiskDownload\Typora\Computer System\06.链接.assets\image-20220121102100411.png)


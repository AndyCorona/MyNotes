# 第七章 异常

## 底层异常

计算机系统的底层异常由硬件和操作系统共同实现。当处理器检测到异常发生时，通过一张叫做异常表的跳转表，调用指定的异常处理程序。

![异常的发生](E:\BaiduNetdiskDownload\Typora\Computer System\07.异常.assets\image-20220122140828171.png)

### 异常处理

每种类型的异常都有唯一的异常号。一些异常号由处理器设计者分配，例如被零除、缺页、算数运算溢出等；另一些异常号由操作系统内核设计者分配，例如系统调用和来自外部 I/O 设备的信号。

操作系统在系统启动时分配和初始化一张称为异常表的跳转表，发生异常时调用对应的异常处理程序。

![异常表](E:\BaiduNetdiskDownload\Typora\Computer System\07.异常.assets\image-20220122141422325.png)

### 异常类别

异常分为四类：中断、陷阱、故障和终止。

| 类别 | 原因                | 异步/同步 | 返回行为           |
| ---- | ------------------- | --------- | ------------------ |
| 中断 | 来自 I/O 设备的信号 | 异步      | 总是返回下一条指令 |
| 陷阱 | 系统调用            | 同步      | 总是返回下一条指令 |
| 故障 | 潜在可恢复的错误    | 同步      | 可能返回当前指令   |
| 终止 | 不可恢复的错误      | 同步      | 不会返回           |

#### 中断

来自外部 I/O 设备的信号导致中断异常。硬件中断的异常处理程序称为中断处理程序。

![中断异常](E:\BaiduNetdiskDownload\Typora\Computer System\07.异常.assets\image-20220123121326697.png)

#### 陷阱

系统调用指令导致陷阱异常。用户程序向内核请求服务时执行 syscall 指令，该指令导致控制权转移到陷阱处理程序上。该程序负责调用指定的内核程序给应用程序提供服务。

![陷阱异常](E:\BaiduNetdiskDownload\Typora\Computer System\07.异常.assets\image-20220123121345268.png)

#### 故障

发生故障时导致故障异常。若故障处理程序能修复故障，将控制权返回当前指令；若无法修复故障，控制权转移到内核的 abort 程序。

![故障异常](E:\BaiduNetdiskDownload\Typora\Computer System\07.异常.assets\image-20220123121428167.png)

#### 终止

发生一些不可恢复的致命错误时导致终止异常。终止处理程序将控制权转移给 abort 程序并终止当前应用程序。

![终止异常](E:\BaiduNetdiskDownload\Typora\Computer System\07.异常.assets\image-20220123121444639.png)

### x86-64 异常

x86-64 系统定义了 256 中异常。0~31 号由 Intel 架构师定义，32~255 号由操作系统定义。

| 异常号 | 描述               | 异常类别   |
| ------ | ------------------ | ---------- |
| 0      | 除法错误           | 故障       |
| 13     | 一般性保护故障     | 故障       |
| 14     | 缺页               | 故障       |
| 18     | 机器检查           | 终止       |
| 32~255 | 操作系统定义的异常 | 中断或陷阱 |

Linux 中每个系统调用都有一个唯一的整数号。通过该整数号调用指定的系统服务。

| 编号 | 名字   | 描述             |
| ---- | ------ | ---------------- |
| 0    | read   | 读文件           |
| 1    | write  | 写文件           |
| 2    | open   | 打开文件         |
| 3    | close  | 关闭文件         |
| 4    | stat   | 获得文件信息     |
| 39   | getpid | 获得进程 ID      |
| 57   | fork   | 创建进程         |
| 59   | execve | 执行一个程序     |
| 60   | _exit  | 终止进程         |
| 61   | wait4  | 等待一个进程终止 |

## 应用级异常

高级编程语言如 C、C++、Java 等都提供了应用级别的异常处理。C 中利用 setjmp 和 longjmp 函数提供异常跳转；Java 利用 catch 和 throw 提供异常跳转。